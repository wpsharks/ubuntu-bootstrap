# ----------------------------------------------------------------------------------------------------------------------

# General (main context).

pid /run/nginx.pid;
user www-data www-data;
worker_processes auto;

events {
  worker_connections 768;
  # See: <http://jas.xyz/1mgiQlM>
  # This is altered dynamically by the bootstrap/installer.
  # See: `/bootstrap/src/bin/set-resource-limits`.
}

# ----------------------------------------------------------------------------------------------------------------------

# Web server (http context).

http {
  # Performance.

  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;

  # DNS resolution.

  resolver_timeout 5s;
  resolver 8.8.8.8 8.8.4.4;

  # Buffer tweaks.

  client_max_body_size 10m;
  client_body_buffer_size 10k;
  client_header_buffer_size 1k;
  large_client_header_buffers 4 8k;

  # Reasonable timeouts.

  client_body_timeout 10s;
  client_header_timeout 10s;
  keepalive_timeout 15s 15s;
  send_timeout 10s;

  # Open file cache.

  open_file_cache max=5000 inactive=30s;
  open_file_cache_valid 30s;
  open_file_cache_min_uses 2;
  open_file_cache_errors on;

  # Log file settings.

  error_log /var/log/nginx/error.log;
  access_log /var/log/nginx/access.log;

  # Directory indexing.

  index index.html index.php;

  # Configure several MIME types.

  types {
    text/xml xml;
    text/plain txt md;
    text/html html htm;

    application/rss+xml rss;
    application/atom+xml atom;
    application/xhtml+xml xhtml;

    text/css css;
    application/json json;
    application/x-javascript js;

    image/gif gif;
    image/png png;
    image/x-icon ico;
    image/x-ms-bmp bmp;
    image/tiff tif tiff;
    image/svg+xml svg svgz;
    application/postscript ai eps;
    image/jpeg jpg jpeg jpe;

    audio/mpeg mp3;
    audio/ogg ogg;
    audio/midi mid midi;

    video/mp4 mp4;
    video/x-flv flv;
    video/webm webm;
    video/x-ms-wmv wmv;
    video/x-msvideo avi;
    video/quicktime mov;
    video/mpeg mpeg mpg;
    application/x-shockwave-flash swf;

    application/font-otf otf;
    application/font-ttf ttf;
    application/font-woff woff woff2;
    application/vnd.ms-fontobject eot;

    application/x-x509-ca-cert crt pem;

    application/zip zip;
    application/gzip gz;
    application/x-gtar tgz;
    application/x-httpd-php phar;
    application/x-7z-compressed 7z;
    application/x-rar-compressed rar;
    application/java-archive jar war ear;

    application/x-redhat-package-manager rpm;
    application/octet-stream deb dmg exe msi dll;

    application/pdf pdf;
    application/rtf rtf;
    application/msword doc;
    application/vnd.ms-excel xls;
    application/vnd.ms-powerpoint ppt;
    application/vnd.openxmlformats-officedocument.spreadsheetml.sheet xlsx;
    application/vnd.openxmlformats-officedocument.wordprocessingml.document docx;
    application/vnd.openxmlformats-officedocument.presentationml.presentation pptx;
  }
  default_type application/octet-stream;

  # Prevent MIME sniffing. See: <http://jas.xyz/1kVvF41>

  add_header x-content-type-options nosniff always;

  # GZIP compresion for compressable MIME types.

  gzip on; gzip_vary on; gzip_comp_level 6; # Enable GZIP.

  gzip_types text/plain text/xml # text/html is already in Nginx core.
    image/svg+xml application/rss+xml application/atom+xml application/xhtml+xml
    text/css application/json application/x-javascript
    application/font-otf application/font-ttf;

  # Map access-control-allow-origin header.

  map $uri $access_control_allow_origin {
    default '';
    ~*\.(?:otf|ttf|woff|woff2|eot)$ '*';
  }
  add_header access-control-allow-origin $access_control_allow_origin;

  # Client-side cache.

  if_modified_since exact;
  etag on; # See: <http://jas.xyz/1MzvnWz>

  map $uri $_expires {
    default 5d;
    ~*\.php$ off;
  }
  expires $_expires;

# ----------------------------------------------------------------------------------------------------------------------

  # HTTP (server context).

  server {
    # Any.

    server_name _;

    # HTTP only.

    listen 80 default_server;
    listen [::]:80 default_server;

    # Force HTTPS at all times.

    return 301 https://$host$request_uri;
  }

# ----------------------------------------------------------------------------------------------------------------------

  # HTTPS (server context; primary default).

  server {
    # Any.

    server_name _;

    # Doc root.

    root /app/src;

    # SSL over HTTPS/2.

    listen 443 default_server ssl http2;
    listen [::]:443 default_server ssl http2;

    # Force no `www.` prefix.

    if ($host ~* ^www\.(.*)) {
      return 301 $scheme://$1$request_uri;
    }

    # Security considerations.

    if ($uri ~* /\.) {
      return 403;
    }
    if ($uri ~* ~(?:/|$)) {
      return 403;
    }
    if ($uri ~* /xmlrpc\.php$) {
      return 403;
    }
    if ($uri ~* /phpinfo\.php$) {
      return 403;
    }
    if ($uri ~* \.(?:bak|copy|log|old|tmp)$) {
      return 403;
    }
    if ($uri ~* /(?:uploads|files)/.*?\.php$) {
      return 403;
    }
    if ($uri ~* /(?:includes|vendor)/.*?\.php$) {
      return 403;
    }
    if ($uri ~* /(?:mu\-plugins)/.*?\.php$) {
      return 403;
    }
    if ($uri ~* /(?:wp\-)?config(?:\.inc)?\.php$) {
      return 403;
    }
    if ($request_uri ~* ^/\-\-\-errors/[^/]+(?:/index\.(?:html|php)|/)?(?:[?&]|$)) {
      return 403; # Disallow direct access to error pages.
    }
    if ($request_uri ~* ^/\-\-\-coming\-soon(?:/index\.(?:html|php)|/)?(?:[?&]|$)) {
      return 403; # Disallow direct access to coming soon pages.
    }

    # Maintenance detection.

    set $_maintenance off;

    if (-f /app/.maintenance) {
      set $_maintenance on;
    }
    if (-f /app/.~maintenance) {
      set $_maintenance on;
    }
    if ($request_uri ~* ^/\-\-\-errors/503(?:[/?&]|$)) {
      set $_maintenance allow_503_access;
    }
    if ($request_uri ~* ^/(?:mbypass|wp\-cron)\.php(?:[?&]|$)) {
      set $_maintenance allow_503_access;
    }
    if ($cookie_maintenance_bypass = '%%cookie_maintenance_bypass_value%%') {
      set $_maintenance allow_cookie_bypass;
    }
    if ($_maintenance = on) {
      return 503;
    }

    ## Error handlers.

    error_page 503 @errors-503;
    error_page 404 @errors-404;

# ----------------------------------------------------------------------------------------------------------------------

    # Locations (same server context).

    ## Robots/favicon.

    location = /robots.txt {
      access_log off;
      log_not_found off;
    }
    location = /favicon.ico {
      access_log off;
      log_not_found off;
    }
    ## Adminisrative tools.

    location ^~ /---tools/ {
      root /bootstrap/src/tools;

      client_max_body_size 200m; # PHP max.

      auth_basic 'Administrative Tools';
      auth_basic_user_file /etc/bootstrap/passwds/.tools;

      location = /---tools/status.nginx {
        stub_status yes; # Status page.
      }
      location ~* ^/\-\-\-tools/fpm\-(?:ping|status)\.php$ {
        include /bootstrap/src/nginx/snippets/fastcgi-php-virtual.conf;
      }
      location ~* \.php$ {
        rewrite ^/\-\-\-tools(.*) $1 break;
        include /bootstrap/src/nginx/snippets/fastcgi-php.conf;
      }
      location ~* ^/\-\-\-tools(?<sub_dir>.*?)/$ {
        try_files $sub_dir/index.html $uri/index.php;
      }
      rewrite ^/\-\-\-tools(.*) $1 break;
    }
    ## WordPress adminisrative area.

    location ^~ /wp-admin/ {
      client_max_body_size 200m; # PHP max.
      include /bootstrap/src/nginx/snippets/php-ext-location.conf;
      include /bootstrap/src/nginx/snippets/static-exts-location.conf;
      try_files $uri $uri/ =404; # No `/index.php` default here.
    }
    ## Error locations.

    location @errors-503 {
      internal; # Only.
      expires -1; # No cache.
      add_header retry-after 300;
      rewrite ^ /---errors/503/index.html last;
    }
    location @errors-404 {
      internal; # Requests only.
      rewrite ^ /---errors/404/index.html last;
    }
    location ~* ^/\-\-\-errors/(?<error_code>[0-9]+)/ {
      root /bootstrap/src/html/errors/$error_code/default;
      rewrite ^/\-\-\-errors/[0-9]+(.*) $1 break;
    }
    ## Coming soon locations.

    location ~* ^/\-\-\-coming\-soon/ {
      root /bootstrap/src/html/coming-soon/default;
      rewrite ^/\-\-\-coming\-soon(.*) $1 break;
    }
    ## Default file handling w/ PHP fallback.

    include /bootstrap/src/nginx/snippets/php-ext-location.conf;
    include /bootstrap/src/nginx/snippets/static-exts-location.conf;
    include /bootstrap/src/nginx/snippets/default-location-php-fallback.conf;

# ----------------------------------------------------------------------------------------------------------------------

    # SSL config (same server context).

    ssl_stapling on;
    ssl_stapling_verify on;

    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off; # <http://jas.xyz/1O8Rs27>

    ssl_certificate_key /etc/bootstrap/ssl/official-private-key.pem;
    ssl_certificate /etc/bootstrap/ssl/official-fullchain.pem;
    ssl_trusted_certificate /etc/bootstrap/ssl/official-fullchain.pem;
    ssl_dhparam /etc/bootstrap/ssl/dhparam.pem;

    ssl_prefer_server_ciphers on; # Prefer our cipher suite order.
    ssl_protocols TLSv1.1 TLSv1.2; # Limit to these SSL protocols only.
    add_header strict-transport-security 'max-age=31536000; includeSubdomains; preload' always;
    ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!3DES:!MD5:!PSK';
    # See: <https://mozilla.github.io/server-side-tls/ssl-config-generator/>. See also: <https://cipherli.st/>

# ----------------------------------------------------------------------------------------------------------------------

    # Includes (server context).

    include /etc/nginx/conf.d/server/*.conf;
  }
# ----------------------------------------------------------------------------------------------------------------------

  # Includes (http context).

  include /etc/nginx/conf.d/http/*.conf;
}
